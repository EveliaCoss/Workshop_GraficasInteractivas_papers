# Empleo de `plotly`

Vamos a crear un gr치fico de burbujas interactivo con el paquete **plotly**, usando el dataset `gapminder`. Este gr치fico mostrar치:

-   `gdpPercap` -El PIB per c치pita (eje X)
-   `lifeExp` -La esperanza de vida (eje Y)
-   `pop` - El tama침o de la poblaci칩n (tama침o del punto)
-   `country`  - El continente (color)

Cargar paquetes en R

```{r packages, warning=FALSE, message=FALSE}
library(tidyverse) # Manipulacion, limpieza y visualizacion de datos
library(gapminder) # Base de datos
library(DT)        # Tablas bonitas
library(plotly)    # Graficas interactivas
library(viridis)   # Paleta de colores
library(hrbrthemes) # Otros temas
```

## Selecci칩n de datos

En este ejemplo vamos a visualizar la esperanza de vida (`lifeExp`), la poblaci칩n total del pa칤s (`pop`) y el producto interno bruto per c치pita (`gdpPercap`) por cada pais, empleando la informaci칩n general del conjunto de datos [*gapminder*](https://www.gapminder.org/) proveniente del paquete `gapminder` en R.

```{r}
data <- gapminder %>% 
  filter(year=="2007") %>% # seleccionar solo 2007 
  dplyr::select(-year) # Eliminar la columna de year
```

### 쯈u칠 es un *widget*?

Un **widget** es un **componente interactivo de una interfaz gr치fica**. Es una pieza visual que permite a los usuarios interactuar con una aplicaci칩n o presentaci칩n.

En el contexto de **R** y especialmente de **Plotly**, **Shiny**, o **R Markdown/Quarto**, un widget es un elemento que se puede:

-   mover, hacer clic, deslizar, seleccionar, o interactuar de alguna forma.

## Visualizaci칩n gr치fica 1

```{r}
plot1 <- data %>%
  ggplot( aes(gdpPercap, lifeExp, size = pop, color=continent)) +
  geom_point() +
  theme_bw()
# Grafica basica
plot1
```

Convertir a un gr치fico interactivo

La funci칩n `ggplotly()` es parte del paquete **`plotly`** en R, y su principal funci칩n es **convertir gr치ficos hechos con `ggplot2` en gr치ficos interactivos**.

```{r}
ggplotly(plot1)
```

춰Y listo! Ahora el gr치fico es interactivo.

::: callout-note
## 쮺u치ndo conviene usar `plotly`?

-   Cuando est치s explorando datos y quieres ver detalles r치pidamente.
-   Cuando presentas resultados a personas no t칠cnicas que quieren "jugar" con los datos.
-   En dashboards hechos con **Shiny** o presentaciones en **R Markdown/Quarto HTML**.
:::

## Visualizaci칩n gr치fica 2

```{r plot2, message=FALSE, warning=FALSE}
# Seleccion de datos
plot2_df <- data %>%
  # Cambiar formatos
  mutate(gdpPercap = round(gdpPercap,0)) %>% # Eliminar decimales
  mutate(pop = round(pop/1000000,2)) %>% # Dejar en milones con dos decimas
  mutate(lifeExp = round(lifeExp,1)) %>% # dejar a una decimal
  # Eeordenar esferas por pop
  arrange(desc(pop)) %>%
  mutate(country = factor(country, country)) %>%
  # Preparar etiquetas (tooltip)
  mutate(text = paste("Pais: ", country, "\nPoblaci칩n (M): ", 
                      pop, "\nEsperanza de vida: ", lifeExp, "\nGdp per capita: ", gdpPercap, sep="")) 
  
# Grafica basica
plot2 <- plot2_df %>%
  ggplot( aes(x=gdpPercap, y=lifeExp, size = pop, color = continent, text=text)) +
  geom_point(alpha=0.7) +
  scale_size(range = c(1.4, 19), name="Poblaci칩n (M)") +
  scale_color_viridis(discrete=TRUE, guide=FALSE) +
  theme_ipsum() +
  theme(legend.position="none")

plot2
```

Convertir a plot interactivo

```{r}
plot2_interactive <- ggplotly(plot2, tooltip="text")
plot2_interactive
```

Almacenar o guardar la informaci칩n (widget)

```{r, message=FALSE, warning=FALSE}
library(htmlwidgets)

saveWidget(plot2_interactive, file= "graphs/ggplotlyBubblechart.html")
```

::: {.callout-important icon="false"}
### En resumen 

-   Un widget es cualquier elemento interactivo en una aplicaci칩n o presentaci칩n.
-   Los gr치ficos interactivos con Plotly son widgets.
:::

## Visualizaci칩n gr치fica 3

### Paso 1: Crear el gr치fico con `plot_ly()`

```{r plot3}
plot3 <- gapminder %>%
  plot_ly(
    x = ~gdpPercap,         # Eje X: PIB per c치pita
    y = ~lifeExp,           # Eje Y: Esperanza de vida
    size = ~pop,            # Tama침o de burbuja: Poblaci칩n
    color = ~continent,     # Color: Continente
    frame = ~year,          # Fotograma para animaci칩n: A침o
    text = ~country,        # Texto al pasar el cursor: Nombre del pa칤s
    hoverinfo = "text",     # Muestra solo el texto personalizado
    type = 'scatter',       # Tipo de gr치fico: Dispersi칩n
    mode = 'markers'        # Solo marcadores (sin l칤neas)
  )
```

Esto genera un gr치fico de burbujas por a침o, con diferentes colores seg칰n el continente y tama침os seg칰n la poblaci칩n.

### Paso 2: Ajustar el eje X a escala logar칤tmica

Como los valores del PIB per c치pita var칤an mucho entre pa칤ses, es mejor mostrar el eje X en **escala logar칤tmica** para facilitar la comparaci칩n:

```{r plot3_interactive, message=FALSE, warning=FALSE}
plot3_interactive <- plot3 %>% layout(
  xaxis = list(
    type = "log"  # Escala logar칤tmica en el eje X
  )
)

# Visualizar el gr치fico
plot3_interactive
```

Esto muestra un gr치fico animado, donde puedes:

-   Usar los botones para avanzar a침o por a침o.
-   Hacer *hover* sobre un punto para ver el pa칤s.
-   Hacer *zoom* o mover el gr치fico con el mouse.

## 游닇 Recomendaciones:

| 쯈uieres...?                                             | Usa...       |
|----------------------------------------------------------|--------------|
| Convertir un gr치fico `ggplot2` a interactivo r치pidamente | `ggplotly()` |
| Crear un gr치fico totalmente interactivo desde cero       | `plot_ly()`  |
| Hacer animaciones (por a침o, tiempo, etc.)                | `plot_ly()`  |
| Personalizar profundamente la interacci칩n del gr치fico    | `plot_ly()`  |

## **Referencias**

-   Ejemplo1: Plotly - [Quick start](https://r-graph-gallery.com/plotly.html)

-   Ejemplo2: Plotly - [Ejemplo 2 de burbujas](https://r-graph-gallery.com/bubble_chart_interactive_ggplotly.html)

-   Ejemplo3: Plotly - [Animacion](https://plotly.com/r/animations/)
